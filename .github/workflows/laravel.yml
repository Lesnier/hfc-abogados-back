name: Deploy Laravel - Fix 425 with Diagnostics

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      # ============================================
      # Crear .env
      # ============================================
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_NAME="${{ secrets.APP_NAME }}"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}

          LOG_CHANNEL=stack
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120

          DEPLOY_TOKEN=${{ secrets.DEPLOY_TOKEN }}

          MAIL_MAILER=${{ secrets.MAIL_MAILER }}
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME="${{ secrets.APP_NAME }}"
          EOF

      - name: Create directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: Clean unnecessary files
        run: |
          rm -rf .git .github tests node_modules
          rm -f .gitignore .gitattributes .editorconfig phpunit.xml README.md
          rm -f package*.json webpack.mix.js vite.config.js .env.example

      # ============================================
      # Deploy vÃ­a FTP
      # ============================================
      - name: Deploy to FTP
        uses: sebastianpopp/ftp-action@releases/v2
        with:
          host: ${{ secrets.FTP_SERVER }}
          user: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          localDir: "./"
          remoteDir: ${{ secrets.FTP_SERVER_DIR }}
          options: "--delete --verbose --transfer-all"

      # ============================================
      # Post-deploy: DiagnÃ³stico y ejecuciÃ³n
      # ============================================
      - name: Wait for files to sync
        run: sleep 10

      - name: Test if routes are accessible
        run: |
          echo "ðŸ§ª Testing if deploy routes are accessible..."
          curl -f "${{ secrets.APP_URL }}/deploy-test" || echo "âš ï¸  Deploy test route not accessible"
        continue-on-error: true

      - name: Check server status
        run: |
          echo "ðŸ“Š Checking server status..."
          curl -s "${{ secrets.APP_URL }}/deploy/status?token=${{ secrets.DEPLOY_TOKEN }}" | jq '.' || echo "âš ï¸  Status check failed"
        continue-on-error: true

      - name: Test shell_exec capability
        run: |
          echo "ðŸ” Testing shell_exec..."
          curl -s "${{ secrets.APP_URL }}/deploy/test-shell?token=${{ secrets.DEPLOY_TOKEN }}" | jq '.' || echo "âš ï¸  Shell test failed"
        continue-on-error: true

      - name: Create storage symlink
        run: |
          echo "ðŸ”— Creating storage symlink..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 60 "${{ secrets.APP_URL }}/deploy/storage-link?token=${{ secrets.DEPLOY_TOKEN }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Storage symlink created"
          else
            echo "âš ï¸  Storage symlink failed (non-critical)"
          fi
        continue-on-error: true

      - name: Execute composer install (with retries)
        run: |
          echo "ðŸ”§ Executing composer install..."

          for i in {1..3}; do
            echo "Attempt $i of 3..."

            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 600 "${{ secrets.APP_URL }}/deploy/composer-install?token=${{ secrets.DEPLOY_TOKEN }}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "HTTP Status: $HTTP_CODE"
            echo "Response Body:"
            echo "$BODY" | jq '.' || echo "$BODY"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Composer install completed successfully"
              break
            else
              echo "âŒ Attempt $i failed with status $HTTP_CODE"

              # Mostrar logs si es posible
              echo "ðŸ“ Checking logs..."
              curl -s "${{ secrets.APP_URL }}/deploy/logs?token=${{ secrets.DEPLOY_TOKEN }}&lines=30" | jq '.logs' || echo "Could not fetch logs"

              if [ $i -lt 3 ]; then
                echo "â³ Waiting 15 seconds before retry..."
                sleep 15
              else
                echo "âŒ All attempts failed"
                echo ""
                echo "==================================="
                echo "ðŸ” DIAGNOSTIC INFORMATION"
                echo "==================================="
                echo "1. Check if shell_exec is enabled"
                echo "2. Check if composer is installed"
                echo "3. Check server logs"
                echo "4. Consider using deploy-with-vendor.yml instead"
                echo "==================================="
                exit 1
              fi
            fi
          done

      - name: Optimize Laravel
        run: |
          echo "ðŸš€ Optimizing Laravel..."
          RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 60 "${{ secrets.APP_URL }}/deploy/optimize?token=${{ secrets.DEPLOY_TOKEN }}")
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')

          echo "HTTP Status: $HTTP_CODE"
          echo "$BODY" | jq '.' || echo "$BODY"

          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Laravel optimized"
          else
            echo "âš ï¸  Optimization failed (non-critical)"
          fi
        continue-on-error: true

      - name: Final status check
        run: |
          echo "ðŸ“Š Final server status:"
          curl -s "${{ secrets.APP_URL }}/deploy/status?token=${{ secrets.DEPLOY_TOKEN }}" | jq '{
            vendor_exists,
            storage_linked,
            exec_enabled: .php_functions.shell_exec,
            composer,
            disk_space_mb
          }' || echo "Status check failed"
        continue-on-error: true

      - name: Deploy Summary
        run: |
          echo "================================"
          echo "ðŸŽ‰ Deploy Process Complete!"
          echo "================================"
          echo "ðŸŒ Site: ${{ secrets.APP_URL }}"
          echo ""
          echo "Next steps if composer failed:"
          echo "1. Visit: ${{ secrets.APP_URL }}/deploy/status?token=***"
          echo "2. Check: exec_enabled and composer fields"
          echo "3. If shell_exec disabled, use deploy-with-vendor.yml"
          echo "================================"
