name: Deploy Laravel to Production (FTP - Improved)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 45  # Timeout mÃ¡s largo

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP (for validation only)
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      # ============================================
      # Crear archivo .env con secrets
      # ============================================
      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_NAME="${{ secrets.APP_NAME }}"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}

          LOG_CHANNEL=stack
          LOG_DEPRECATIONS_CHANNEL=null
          LOG_LEVEL=error

          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}

          BROADCAST_DRIVER=log
          CACHE_DRIVER=file
          FILESYSTEM_DISK=local
          QUEUE_CONNECTION=sync
          SESSION_DRIVER=file
          SESSION_LIFETIME=120

          DEPLOY_TOKEN=${{ secrets.DEPLOY_TOKEN }}

          MAIL_MAILER=${{ secrets.MAIL_MAILER }}
          MAIL_HOST=${{ secrets.MAIL_HOST }}
          MAIL_PORT=${{ secrets.MAIL_PORT }}
          MAIL_USERNAME=${{ secrets.MAIL_USERNAME }}
          MAIL_PASSWORD=${{ secrets.MAIL_PASSWORD }}
          MAIL_ENCRYPTION=${{ secrets.MAIL_ENCRYPTION }}
          MAIL_FROM_ADDRESS=${{ secrets.MAIL_FROM_ADDRESS }}
          MAIL_FROM_NAME="${{ secrets.APP_NAME }}"
          EOF

      - name: Create necessary directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache

      - name: Set permissions
        run: |
          chmod -R 775 storage bootstrap/cache

      # ============================================
      # Limpiar archivos innecesarios AGRESIVAMENTE
      # ============================================
      - name: Clean up unnecessary files
        run: |
          # Eliminar directorios completos
          rm -rf .git
          rm -rf .github
          rm -rf tests
          rm -rf node_modules

          # Eliminar archivos individuales
          rm -f .gitignore .gitattributes .editorconfig
          rm -f phpunit.xml README.md
          rm -f package.json package-lock.json
          rm -f webpack.mix.js vite.config.js
          rm -f .env.example

          # Limpiar logs antiguos
          rm -rf storage/logs/*.log

          # Limpiar cachÃ©s viejas
          rm -rf storage/framework/cache/data/*
          rm -rf storage/framework/sessions/*
          rm -rf storage/framework/views/*

      # Contar archivos antes del upload
      - name: Count files to upload
        run: |
          echo "ðŸ“Š Files to upload:"
          find . -type f | wc -l
          echo "ðŸ“¦ Total size:"
          du -sh .

      # ============================================
      # Deploy vÃ­a FTP con configuraciones optimizadas
      # ============================================
      - name: Deploy to FTP (Optimized)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          protocol: ftps  # Probar con ftps primero
          port: 21
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          # Timeout MUY largo
          timeout: 1800000  # 30 minutos
          # Log detallado para debuggear
          log-level: verbose
          # Excluir archivos innecesarios
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/tests/**
            **/vendor/**
            **/.env.example
            **/storage/logs/*.log
            **/storage/framework/cache/**
            **/storage/framework/sessions/**
            **/storage/framework/views/**
          # No limpiar el servidor antes de subir
          dangerous-clean-slate: false
          # Verificar la integridad de los archivos
          # dry-run: false  # Cambiar a true para probar sin subir

      # ============================================
      # Alternativa: Si FTP sigue fallando, dividir en partes
      # ============================================
      # - name: Deploy core files first
      #   uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      #   with:
      #     server: ${{ secrets.FTP_SERVER }}
      #     username: ${{ secrets.FTP_USERNAME }}
      #     password: ${{ secrets.FTP_PASSWORD }}
      #     local-dir: ./
      #     server-dir: ${{ secrets.FTP_SERVER_DIR }}
      #     exclude: |
      #       **/storage/**
      #       **/bootstrap/**
      #       **/public/**
      #     timeout: 900000

      # - name: Deploy storage separately
      #   uses: SamKirkland/FTP-Deploy-Action@v4.3.0
      #   with:
      #     server: ${{ secrets.FTP_SERVER }}
      #     username: ${{ secrets.FTP_USERNAME }}
      #     password: ${{ secrets.FTP_PASSWORD }}
      #     local-dir: ./storage/
      #     server-dir: ${{ secrets.FTP_SERVER_DIR }}storage/
      #     timeout: 300000

      # ============================================
      # Post-deploy
      # ============================================
      - name: Execute composer install on server
        run: |
          echo "ðŸ”§ Executing composer install on server..."

          for i in {1..3}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 300 "${{ secrets.APP_URL }}/deploy/composer-install?token=${{ secrets.DEPLOY_TOKEN }}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            BODY=$(echo "$RESPONSE" | sed '$d')

            echo "Intento $i - HTTP Status: $HTTP_CODE"

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Composer install completed successfully"
              echo "$BODY" | jq '.' || echo "$BODY"
              break
            else
              echo "âš ï¸  Intento $i fallÃ³"
              if [ $i -lt 3 ]; then
                sleep 10
              else
                exit 1
              fi
            fi
          done

      - name: Optimize Laravel on server
        run: |
          curl -s --max-time 60 "${{ secrets.APP_URL }}/deploy/optimize?token=${{ secrets.DEPLOY_TOKEN }}" | jq '.'
        continue-on-error: true

      - name: Deploy Summary
        run: |
          echo "================================"
          echo "ðŸŽ‰ Deploy Completed!"
          echo "================================"
          echo "ðŸŒ Site: ${{ secrets.APP_URL }}"
          echo "================================"
