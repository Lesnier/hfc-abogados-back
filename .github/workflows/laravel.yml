name: Deploy Laravel in Parts (Split Upload)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          tools: composer:v2

      - name: Validate composer.json
        run: composer validate --strict

      - name: Create .env file
        run: |
          cat > .env << 'EOF'
          APP_NAME="${{ secrets.APP_NAME }}"
          APP_ENV=production
          APP_KEY=${{ secrets.APP_KEY }}
          APP_DEBUG=false
          APP_URL=${{ secrets.APP_URL }}
          DB_CONNECTION=mysql
          DB_HOST=${{ secrets.DB_HOST }}
          DB_PORT=${{ secrets.DB_PORT }}
          DB_DATABASE=${{ secrets.DB_DATABASE }}
          DB_USERNAME=${{ secrets.DB_USERNAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DEPLOY_TOKEN=${{ secrets.DEPLOY_TOKEN }}
          EOF

      - name: Create directories
        run: |
          mkdir -p storage/framework/{sessions,views,cache}
          mkdir -p storage/logs
          mkdir -p bootstrap/cache
          chmod -R 775 storage bootstrap/cache

      - name: Clean files
        run: |
          rm -rf .git .github tests node_modules
          rm -f .gitignore .gitattributes phpunit.xml README.md

      # ============================================
      # Subir en PARTES PEQUEÃ‘AS para evitar timeout
      # ============================================

      # Parte 1: Archivos raÃ­z y config
      - name: Deploy Part 1 - Root & Config
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/app/**
            **/bootstrap/**
            **/config/**
            **/database/**
            **/public/**
            **/resources/**
            **/routes/**
            **/storage/**
            **/vendor/**
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 2: App
      - name: Deploy Part 2 - App Directory
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./app/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}app/
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 3: Config, Routes, Database
      - name: Deploy Part 3 - Config & Routes
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          exclude: |
            **/app/**
            **/bootstrap/**
            **/public/**
            **/resources/**
            **/storage/**
            **/vendor/**
            **/.env.example
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 4: Public
      - name: Deploy Part 4 - Public Directory
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./public/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}public/
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 5: Resources
      - name: Deploy Part 5 - Resources
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./resources/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}resources/
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 6: Storage (vacÃ­o)
      - name: Deploy Part 6 - Storage Structure
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./storage/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}storage/
          exclude: |
            **/logs/**
            **/framework/cache/**
            **/framework/sessions/**
            **/framework/views/**
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # Parte 7: Bootstrap
      - name: Deploy Part 7 - Bootstrap
        uses: SamKirkland/FTP-Deploy-Action@v4.3.0
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          local-dir: ./bootstrap/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}bootstrap/
          timeout: 300000
          log-level: standard
        continue-on-error: true

      # ============================================
      # Post-deploy: Composer install en servidor
      # ============================================
      - name: Wait for files to sync
        run: sleep 15

      - name: Execute composer install
        run: |
          echo "ðŸ”§ Executing composer install..."
          for i in {1..3}; do
            RESPONSE=$(curl -s -w "\n%{http_code}" --max-time 300 "${{ secrets.APP_URL }}/deploy/composer-install?token=${{ secrets.DEPLOY_TOKEN }}")
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)

            if [ "$HTTP_CODE" = "200" ]; then
              echo "âœ… Composer install completed"
              break
            else
              echo "âš ï¸  Attempt $i failed"
              [ $i -lt 3 ] && sleep 10 || exit 1
            fi
          done

      - name: Optimize Laravel
        run: |
          curl -s --max-time 60 "${{ secrets.APP_URL }}/deploy/optimize?token=${{ secrets.DEPLOY_TOKEN }}"
        continue-on-error: true

      - name: Deploy Summary
        run: |
          echo "ðŸŽ‰ Deploy Complete!"
          echo "ðŸŒ ${{ secrets.APP_URL }}"
